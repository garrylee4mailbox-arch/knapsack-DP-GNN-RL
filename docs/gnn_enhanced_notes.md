# ğŸ“˜ GNN ç³»ç»Ÿå¢å¼ºç‰ˆç¬”è®°ï¼ˆæœ€ç»ˆç»“æ„æ ‘ç‰ˆ Â· Markdown å†…å®¹ï¼‰

- [ğŸ“˜ GNN ç³»ç»Ÿå¢å¼ºç‰ˆç¬”è®°ï¼ˆæœ€ç»ˆç»“æ„æ ‘ç‰ˆ Â· Markdown å†…å®¹ï¼‰](#-gnn-ç³»ç»Ÿå¢å¼ºç‰ˆç¬”è®°æœ€ç»ˆç»“æ„æ ‘ç‰ˆ--markdown-å†…å®¹)
- [A. Graph Constructionï¼ˆå›¾æ„å»ºé˜¶æ®µï¼‰](#a-graph-constructionå›¾æ„å»ºé˜¶æ®µ)
  - [A0. Why we use Graph?](#a0-why-we-use-graph)
  - [A1. Graph Structureï¼ˆå›¾çš„ç»“æ„å®šä¹‰ï¼‰](#a1-graph-structureå›¾çš„ç»“æ„å®šä¹‰)
  - [A2. Node Featureï¼ˆèŠ‚ç‚¹ç‰¹å¾ï¼‰](#a2-node-featureèŠ‚ç‚¹ç‰¹å¾)
    - [weightï¼ˆé‡é‡ï¼‰](#weighté‡é‡)
    - [valueï¼ˆä»·å€¼ï¼‰](#valueä»·å€¼)
    - [ratioï¼ˆå¯†åº¦ï¼‰](#ratioå¯†åº¦)
    - [one-hotï¼ˆç‹¬çƒ­ç¼–ç ï¼‰](#one-hotç‹¬çƒ­ç¼–ç )
    - [å…¶ä»–ç»Ÿè®¡ç‰¹å¾](#å…¶ä»–ç»Ÿè®¡ç‰¹å¾)
  - [A3. Edge Constructionï¼ˆè¾¹çš„æ„å»ºæ–¹å¼ï¼‰](#a3-edge-constructionè¾¹çš„æ„å»ºæ–¹å¼)
    - [0. Edgeï¼ˆè¾¹ï¼‰= èŠ‚ç‚¹ä¹‹é—´çš„è”ç³»](#0-edgeè¾¹-èŠ‚ç‚¹ä¹‹é—´çš„è”ç³»)
    - [1. Fully-connectedï¼ˆå…¨è¿æ¥ï¼‰](#1-fully-connectedå…¨è¿æ¥)
    - [2. kNNï¼ˆk æœ€è¿‘é‚»å›¾ï¼‰è§£é‡Š](#2-knnk-æœ€è¿‘é‚»å›¾è§£é‡Š)
    - [3. ç›¸ä¼¼åº¦é˜ˆå€¼å›¾ï¼ˆsimilarity \> Ï„ æ‰è¿è¾¹ï¼‰](#3-ç›¸ä¼¼åº¦é˜ˆå€¼å›¾similarity--Ï„-æ‰è¿è¾¹)
  - [A4. Edge Weightï¼ˆå¯é€‰ï¼‰](#a4-edge-weightå¯é€‰)
  - [A5. Self-loopï¼ˆå¯é€‰ï¼‰](#a5-self-loopå¯é€‰)
- [B. Node Embeddingï¼ˆèŠ‚ç‚¹åµŒå…¥è¡¨ç¤ºï¼‰](#b-node-embeddingèŠ‚ç‚¹åµŒå…¥è¡¨ç¤º)
  - [B1. What is Embedding](#b1-what-is-embedding)
  - [B2. åˆå§‹ Embedding](#b2-åˆå§‹-embedding)
- [C. Message Passingï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰](#c-message-passingæ ¸å¿ƒæœºåˆ¶)
  - [C0. Overall Intro](#c0-overall-intro)
  - [C1. Neighbor Collection](#c1-neighbor-collection)
  - [C2. Message Function](#c2-message-function)
  - [C3. Aggregationï¼ˆèšåˆï¼‰](#c3-aggregationèšåˆ)
  - [C4. Updateï¼ˆæ›´æ–°é˜¶æ®µï¼‰ï¼šç”¨æ±‡æ€»ä¿¡æ¯æ›´æ–°èŠ‚ç‚¹ embedding](#c4-updateæ›´æ–°é˜¶æ®µç”¨æ±‡æ€»ä¿¡æ¯æ›´æ–°èŠ‚ç‚¹-embedding)
  - [C5. Multi-layer Message Passingï¼ˆå¤šå±‚ GNNï¼‰è®©ä¿¡æ¯çœ‹å¾—æ›´è¿œ](#c5-multi-layer-message-passingå¤šå±‚-gnnè®©ä¿¡æ¯çœ‹å¾—æ›´è¿œ)
- [D. Readoutï¼ˆå›¾çº§åˆ«èšåˆ Â· å¯é€‰ï¼‰](#d-readoutå›¾çº§åˆ«èšåˆ--å¯é€‰)
- [E. Decision Makingï¼ˆå†³ç­–é˜¶æ®µï¼‰](#e-decision-makingå†³ç­–é˜¶æ®µ)
  - [E1. MLP classifier](#e1-mlp-classifier)
  - [E2. Thresholding](#e2-thresholding)
- [F. Training Pipelineï¼ˆè®­ç»ƒæµç¨‹ï¼‰](#f-training-pipelineè®­ç»ƒæµç¨‹)
  - [F1. Loss Functionï¼ˆæŸå¤±å‡½æ•°ï¼‰](#f1-loss-functionæŸå¤±å‡½æ•°)
    - [1) åˆ†ç±»æŸå¤±](#1-åˆ†ç±»æŸå¤±)
    - [2) å®¹é‡çº¦æŸæƒ©ç½šï¼ˆKnapsack å…³é”®ï¼‰](#2-å®¹é‡çº¦æŸæƒ©ç½šknapsack-å…³é”®)
    - [æ€»æŸå¤±](#æ€»æŸå¤±)
  - [F2. Optimizer](#f2-optimizer)
  - [F3. Batch æ„å»ºæ–¹å¼](#f3-batch-æ„å»ºæ–¹å¼)
  - [F4. Epoch è®­ç»ƒ](#f4-epoch-è®­ç»ƒ)
- [ğŸ“Œ GNN å…¨æµç¨‹æ€»ç»“](#-gnn-å…¨æµç¨‹æ€»ç»“)

---
# A. Graph Constructionï¼ˆå›¾æ„å»ºé˜¶æ®µï¼‰

## A0. Why we use Graph?
åœ¨æœºå™¨å­¦ä¹ é‡Œï¼Œæ•°æ®é€šå¸¸æœ‰ç»“æ„ï¼š

- **å›¾åƒ**ï¼šåƒç´ ç»„æˆç½‘æ ¼
- **å¥å­**ï¼šè¯ç»„æˆåºåˆ—  
- **è¡¨æ ¼**ï¼šå±æ€§ç»„æˆè¡Œ

ä½†æœ‰äº›æ•°æ®å¤©ç„¶æ˜¯"ç‚¹ï¼‹å…³ç³»"ï¼š
- ç‰©å“ä¹‹é—´çš„ç›¸ä¼¼æ€§ â†’ Knapsack
- ç¤¾äº¤ç½‘ç»œï¼šäººä¹‹é—´çš„å…³ç³»
- æ¨èç³»ç»Ÿï¼šå•†å“ä¹‹é—´çš„å…±åŒè´­ä¹°å…³ç³»
- åˆ†å­åŒ–å­¦ï¼šåŸå­ä¹‹é—´æ€ä¹ˆè¿æ¥
- åœ°å›¾ï¼šåŸå¸‚ä¹‹é—´è·¯çº¿

è¿™äº›éƒ½ä¸æ˜¯æ•°ç»„ï¼Œè€Œæ˜¯**å›¾ç»“æ„ï¼ˆGraphï¼‰**ï¼š
- **èŠ‚ç‚¹ï¼ˆNodeï¼‰** = "ä¸€ä¸ªå¯¹è±¡"ï¼ˆä¾‹å¦‚ä¸€ä¸ªç‰©å“ï¼‰
- **è¾¹ï¼ˆEdgeï¼‰** = "ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„å…³ç³»"ï¼ˆä¾‹å¦‚ç›¸ä¼¼åº¦é«˜ï¼‰

GNN ä¸“é—¨å¤„ç†è¿™ç§æ•°æ®ã€‚

## A1. Graph Structureï¼ˆå›¾çš„ç»“æ„å®šä¹‰ï¼‰
åœ¨å®ç°ä»»ä½• GNN ä¹‹å‰å¿…é¡»æ˜ç¡®å›¾çš„ç»“æ„ï¼š
- **å›¾ç±»å‹ï¼š** æ— å‘å›¾ / æœ‰å‘å›¾ï¼ˆknapsack å¤šä¸ºæ— å‘å›¾ï¼‰
- **è‡ªç¯ï¼ˆSelf-loopï¼‰ï¼š** æ˜¯å¦è®©èŠ‚ç‚¹ä¸è‡ªå·±è¿è¾¹
- **åŠ æƒè¾¹ï¼ˆWeighted edgesï¼‰ï¼š** æ˜¯å¦ä½¿ç”¨ç›¸ä¼¼åº¦ä½œä¸ºè¾¹çš„æƒé‡
  - ä¾‹å¦‚ cosine similarity / ratio å·®å€¼ / weight å·®å€¼

è¿™äº›å®šä¹‰å†³å®š message passing çš„æ•°å­¦å½¢å¼ã€‚

---
## A2. Node Featureï¼ˆèŠ‚ç‚¹ç‰¹å¾ï¼‰
### weightï¼ˆé‡é‡ï¼‰
### valueï¼ˆä»·å€¼ï¼‰
### ratioï¼ˆå¯†åº¦ï¼‰
Ratioï¼ˆä»·å€¼å¯†åº¦ï¼‰= value / weight

**å®šä¹‰ï¼š** æ¯ 1 å•ä½é‡é‡èƒ½æ¢å¤šå°‘é’±ï¼Ÿ

**ç¤ºä¾‹è¡¨æ ¼ï¼š**
| é‡é‡ | ä»·å€¼ | ratio |
|------|------|-------|
| 3    | 9    | 3     |
| 3    | 4    | 1.33  |

**åº”ç”¨ä»·å€¼ï¼š**
- ratio è¶Šé«˜ï¼Œè¶Š"åˆ’ç®—"
- GNN å¯ä»¥ç”¨ ratio ä½œä¸ºç‰¹å¾ï¼Œè®©å®ƒå­¦ä¼šå“ªäº›ç‰©å“å€¼å¾—ä¼˜å…ˆé€‰
### one-hotï¼ˆç‹¬çƒ­ç¼–ç ï¼‰
**ä½œç”¨ï¼š** å‘Šè¯‰æ¨¡å‹"è¿™æ˜¯ç¬¬å‡ ä¸ªç‰©å“"æˆ–"æ˜¯ä»€ä¹ˆç±»åˆ«"ã€‚

**ç¤ºä¾‹ï¼š**
å‡è®¾ä½ æœ‰ 5 ä¸ªç‰©å“ï¼Œç‰©å“ 3 çš„ one-hot å°±æ˜¯ï¼š[0, 0, 1, 0, 0]

**ç‰¹ç‚¹ï¼š**
- åªäº®ä¸€ä¸ªç¯ï¼Œè¡¨ç¤ºå®ƒçš„èº«ä»½
- GNN ç”¨å®ƒæ¥åŒºåˆ†ä¸åŒç‰©å“
### å…¶ä»–ç»Ÿè®¡ç‰¹å¾
â¡ æ‰€æœ‰ç‰¹å¾ä¼šä½œä¸º embedding çš„è¾“å…¥

---
## A3. Edge Constructionï¼ˆè¾¹çš„æ„å»ºæ–¹å¼ï¼‰
### 0. Edgeï¼ˆè¾¹ï¼‰= èŠ‚ç‚¹ä¹‹é—´çš„è”ç³»

**è¾¹çš„è¿æ¥æ–¹å¼ï¼š**
- `ratio` ç›¸ä¼¼åº¦é«˜ â†’ è¿è¾¹
- `kNN`ï¼ˆk æœ€è¿‘é‚»ï¼‰ â†’ è¿æœ€ç›¸ä¼¼çš„ k ä¸ªç‰©å“
- `fully-connected`ï¼ˆå…¨è¿æ¥ï¼‰ â†’ ä»»æ„ä¸¤ä¸ªç‰©å“éƒ½è¿è¾¹

**ä¸ºä»€ä¹ˆéœ€è¦è¾¹ï¼Ÿ**
å› ä¸º message passing éœ€è¦çŸ¥é“"å‘è°ä¼ æ¶ˆæ¯"ã€‚

å¸¸è§æ–¹å¼ï¼š
### 1. Fully-connectedï¼ˆå…¨è¿æ¥ï¼‰
### 2. kNNï¼ˆk æœ€è¿‘é‚»å›¾ï¼‰è§£é‡Š
**kNN å›¾** = æ¯ä¸ªèŠ‚ç‚¹è¿æ¥ä¸è‡ªå·±æœ€ç›¸ä¼¼çš„ k ä¸ªèŠ‚ç‚¹,æŠŠæ¯ä¸ªç‰©å“å’Œ"æœ€åƒå®ƒçš„ä¸€äº›ç‰©å“"è¿èµ·æ¥

**è¿æ¥è§„åˆ™ï¼š**
- A å’Œ B çš„ ratio å¾ˆæ¥è¿‘ â†’ ä»–ä»¬è¿è¾¹
- A å’Œ C çš„é‡é‡å¾ˆæ¥è¿‘ â†’ ä»–ä»¬è¿è¾¹

**ä½œç”¨ï¼š**
GNN åœ¨"æ¶ˆæ¯ä¼ é€’"æ—¶å°±çŸ¥é“ï¼š"A"åº”è¯¥ä»"åƒå®ƒçš„ç‰©å“"é‚£é‡Œå­¦ç»éªŒ

**ä¼˜åŠ¿ï¼š**
GNN åªåœ¨"ç›¸ä¼¼ç‰©å“"ä¹‹é—´ä¼ é€’ä¿¡æ¯ï¼Œæ•ˆç‡é«˜ä¸”æœ‰æ„ä¹‰ã€‚
### 3. ç›¸ä¼¼åº¦é˜ˆå€¼å›¾ï¼ˆsimilarity > Ï„ æ‰è¿è¾¹ï¼‰


---
## A4. Edge Weightï¼ˆå¯é€‰ï¼‰
- ç”¨ ratio å·®å€¼æˆ– cosine similarity ä½œä¸ºè¾¹æƒ
- å½±å“é‚»å±…æƒé‡å’Œæ¶ˆæ¯å¢ç›Š

---
## A5. Self-loopï¼ˆå¯é€‰ï¼‰
- è®©èŠ‚ç‚¹çš„å†å²ä¿¡æ¯ä¹Ÿå‚ä¸æ›´æ–°

---
# B. Node Embeddingï¼ˆèŠ‚ç‚¹åµŒå…¥è¡¨ç¤ºï¼‰

## B1. What is Embedding
è¦ç†è§£ GNNï¼Œä¸€å®šè¦å…ˆç†è§£ embeddingï¼ˆåµŒå…¥ï¼‰ã€‚

**â­ Embedding** = "æŠŠä¸€ä¸ªä¸œè¥¿å˜æˆä¸€ä¸ªå‘é‡ï¼ˆvectorï¼‰"

- ä¸€ä¸ªè¯ï¼šå˜æˆ 300 ç»´ vectorï¼ˆword2vecï¼‰
- ä¸€ä¸ªç‰©å“ï¼šå˜æˆ 64 ç»´ vector  
- ä¸€ä¸ªèŠ‚ç‚¹ï¼šå˜æˆ 128 ç»´ vector

**æœ¬è´¨æ„ä¹‰**ï¼šè®©æ¨¡å‹èƒ½ç”¨æ•°å­¦æ–¹å¼å¤„ç†å¤æ‚å¯¹è±¡ï¼ˆè¯ã€ç‰©ä½“ã€èŠ‚ç‚¹ï¼‰ã€‚å› ä¸ºå‘é‡å¯ä»¥æ•æ‰"è¯­ä¹‰å…³ç³»"å’Œ"ç»“æ„å…³ç³»"ã€‚
**ä¸¾ä¾‹**ï¼š
- "è‹¹æœ"å’Œ"é¦™è•‰" â†’ embedding å¾ˆåƒ
- "ä»·å€¼é«˜ã€é‡é‡ä½"çš„ç‰©å“ä¹‹é—´ â†’ embedding å¾ˆåƒ
- "æœ‰ç›¸ä¼¼è¾¹å’Œé‚»å±…çš„èŠ‚ç‚¹" â†’ embedding å¾ˆåƒ

## B2. åˆå§‹ Embedding
```
h_i^(0) = Linear(x_i)
```
- å°†åŸå§‹ç‰¹å¾æ˜ å°„åˆ°éšè—ç©ºé—´

---
# C. Message Passingï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰
## C0. Overall Intro
>è¿™æ˜¯ GNN çš„çµé­‚ï¼Œç±»æ¯”äººç±»ä¹‹é—´çš„äº¤æµï¼šæ¯ä¸ªèŠ‚ç‚¹ï¼ˆæ¯”å¦‚èƒŒåŒ…é—®é¢˜ä¸­çš„ç‰©å“ï¼‰ä¼šä»ç›¸è¿çš„é‚»å±…èŠ‚ç‚¹é‚£é‡Œæ”¶é›†æœ‰ç”¨ä¿¡æ¯ï¼Œå†ç»“åˆè‡ªèº«æƒ…å†µæ›´æ–°è‡ªå·±çš„çŠ¶æ€â€”â€”è¿™ä¸ªâ€œäº¤æµ+æˆé•¿â€çš„è¿‡ç¨‹ï¼Œå°±æ˜¯ Message Passingã€‚

**å…·ä½“å·¥ä½œæµç¨‹ï¼š**
1. ä»¥ç‰©å“ A ä¸ºä¾‹ï¼Œå®ƒä¼šå…ˆè¯†åˆ«ä¸è‡ªå·±ç›¸è¿çš„é‚»å±…ï¼ˆæ¯”å¦‚ä»·å€¼å¯†åº¦ ratio ç›¸ä¼¼ã€å­˜åœ¨ç»„åˆå…³è”çš„å…¶ä»–ç‰©å“ï¼‰ï¼›
2. ä»è¿™äº›é‚»å±…é‚£é‡Œâ€œå­¦ä¹ â€å…³é”®ä¿¡æ¯ï¼ˆæ¯”å¦‚é‚»å±…çš„é‡é‡ã€ä»·å€¼ã€æ˜¯å¦é€‚åˆä¸€èµ·è¢«é€‰ä¸­ç­‰ï¼‰ï¼›
3. æŠŠæ”¶é›†åˆ°çš„é‚»å±…ä¿¡æ¯ä¸è‡ªèº«ä¿¡æ¯æ•´åˆï¼Œæœ€ç»ˆæ›´æ–°è‡ªå·±çš„ç‰¹å¾å‘é‡ï¼ˆembeddingï¼‰ã€‚

**æ•°å­¦è¡¨è¾¾ï¼ˆä¸ç”¨èƒŒï¼Œç†è§£é€»è¾‘å³å¯ï¼‰ï¼š**
$$new\_state(A) = f(A, \sum(\text{neighbors' states}))$$
- å…¬å¼ä¸­ï¼Œ`A` ä»£è¡¨ç‰©å“ A çš„è‡ªèº«åŸå§‹çŠ¶æ€ï¼Œ`sum(neighbors' states)` å°±æ˜¯å¯¹é‚»å±…ä¿¡æ¯çš„â€œåˆå¹¶æ“ä½œâ€ï¼Œ`f` æ˜¯æ•´åˆè‡ªèº«ä¸é‚»å±…ä¿¡æ¯çš„æ›´æ–°å‡½æ•°ã€‚

**æ ¸å¿ƒè¦ç‚¹ï¼š**
- éšç€å¤šæ¬¡ Message Passing çš„è¿­ä»£ï¼ŒGNN ä¼šé€æ¸å­¦ä¼šâ€œå“ªäº›ç‰©å“ä¹‹é—´ç»„åˆæ›´å¯èƒ½å½¢æˆé«˜ä»·å€¼ã€ä¸è¶…é‡çš„é›†åˆâ€ï¼›
- è¿™ç§èƒ½è‡ªåŠ¨å­¦ä¹ â€œç»„åˆå…³è”â€çš„èƒ½åŠ›ï¼Œæ­£æ˜¯ GNN å¤©ç„¶é€‚åˆè§£å†³èƒŒåŒ…é—®é¢˜çš„å…³é”®ã€‚

**Message Passing æ˜¯ GNN çš„å¿ƒè„ï¼š**
$h_i^{(l+1)} = \text{UPDATE}( h_i^{(l)}, \text{AGGREGATE}({ \text{MESSAGE}(h_j) | j \in N(i) }) )$

---
## C1. Neighbor Collection
- ç”±å›¾ç»“æ„ï¼ˆA é˜¶æ®µï¼‰å†³å®šé‚»å±… N(i)

---
## C2. Message Function
- ä»é‚»å±…æå–ä¿¡æ¯
- å¸¸è§å½¢å¼ï¼šMLP(h_j)

---
## C3. Aggregationï¼ˆèšåˆï¼‰
Aggregationï¼ˆèšåˆï¼‰ï¼šMessage Passing ä¸­çš„æ ¸å¿ƒå­æ­¥éª¤

ä¸Šé¢å…¬å¼é‡Œçš„ `sum(neighbors' states)`ï¼Œæœ¬è´¨å°±æ˜¯ Aggregationâ€”â€”å®ƒæ˜¯ Message Passing æµç¨‹ä¸­â€œåˆå¹¶é‚»å±…æ¶ˆæ¯â€çš„å…³é”®ç¯èŠ‚ï¼Œæ²¡æœ‰èšåˆï¼Œåˆ†æ•£çš„é‚»å±…ä¿¡æ¯æ— æ³•è¢«èŠ‚ç‚¹æœ‰æ•ˆåˆ©ç”¨ã€‚

**ä¸ºä»€ä¹ˆå¿…é¡»èšåˆï¼Ÿ**
ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½è¿æ¥å¤šä¸ªé‚»å±…ï¼ˆæ¯”å¦‚ç‰©å“ A è¿äº† 10 ä¸ªå…¶ä»–ç‰©å“ï¼‰ï¼Œå¦‚æœæŠŠæ¯ä¸ªé‚»å±…çš„æ¶ˆæ¯éƒ½å•ç‹¬å¤„ç†ï¼Œä¸ä»…æ•ˆç‡ä½ï¼Œè¿˜ä¼šå¯¼è‡´ä¿¡æ¯å†—ä½™æ··ä¹±ï¼Œå› æ­¤éœ€è¦é€šè¿‡èšåˆå°†åˆ†æ•£çš„é‚»å±…æ¶ˆæ¯åˆå¹¶ä¸ºç»Ÿä¸€çš„â€œç»¼åˆä¿¡æ¯â€ã€‚

**å¸¸è§èšåˆæ–¹å¼ï¼š**
- `sum`ï¼ˆæ±‚å’Œï¼‰ï¼šç®€å•ç²—æš´ï¼Œç›´æ¥ç´¯åŠ æ‰€æœ‰é‚»å±…çš„æ¶ˆæ¯ï¼Œä¿ç•™ä¿¡æ¯æ€»é‡ï¼›
- `mean`ï¼ˆå¹³å‡ï¼‰ï¼šå¯¹é‚»å±…æ¶ˆæ¯å–å¹³å‡ï¼Œå¹³æ»‘æç«¯å€¼çš„å½±å“ï¼›
- `attention`ï¼ˆæ³¨æ„åŠ›åŠ æƒï¼‰ï¼šç»™æ›´é‡è¦çš„é‚»å±…ï¼ˆæ¯”å¦‚ä¸å½“å‰ç‰©å“ç»„åˆä»·å€¼æ›´é«˜çš„é‚»å±…ï¼‰åˆ†é…æ›´é«˜æƒé‡ï¼Œè®©å…³é”®ä¿¡æ¯å‘æŒ¥æ›´å¤§ä½œç”¨ã€‚

---
## C4. Updateï¼ˆæ›´æ–°é˜¶æ®µï¼‰ï¼šç”¨æ±‡æ€»ä¿¡æ¯æ›´æ–°èŠ‚ç‚¹ embedding
- æ–° embedding = f(æ—§ embedding, é‚»å±…ä¿¡æ¯)
- å¯¹åº”å…¬å¼ï¼š\( h_i^{(1)} = f( h_i^{(0)}, \text{é‚»å±… } h_j^{(0)} \text{ çš„åŠ æƒå’Œ} ) \)
- ç±»æ¯”ï¼šâ€œæˆ‘ï¼ˆ\( h_i^{(0)} \)ï¼‰å’Œæœ‹å‹äº¤æµåï¼Œæˆ‘å¯¹é—®é¢˜çš„ç†è§£æ›´æ·±äº†ï¼ˆ\( h_i^{(1)} \)ï¼‰â€

**å…¬å¼æ‹†è§£ä¸å«ä¹‰**
ä¸€å±‚ GNN çš„å®Œæ•´è®¡ç®—é€»è¾‘ï¼š
\[
h_i^{(1)} = f\left( h_i^{(0)}, \quad \sum_{j \in N(i)} \text{Aggregate}(h_j^{(0)}) \right)
\]

- \( h_i^{(0)} \)ï¼šç‰©å“ i ä¸€å¼€å§‹çš„ç‰¹å¾ï¼ˆæ¯”å¦‚ `[w, v, ratio,â€¦]`ï¼‰â†’ **Update é˜¶æ®µçš„â€œè‡ªèº«ä¿¡æ¯â€**
- \( \sum_{j \in N(i)} \text{Aggregate}(h_j^{(0)}) \)ï¼šé‚»å±…ç‰¹å¾çš„èšåˆç»“æœ â†’ **Aggregate é˜¶æ®µçš„è¾“å‡º**
- \( h_i^{(1)} \)ï¼šæ›´æ–°åçš„â€œæ›´èªæ˜â€çš„ç‰¹å¾ï¼Œå·²ç»åŒ…å«äº†å…¶ä»–ç‰©å“çš„ä¿¡æ¯ â†’ **Update é˜¶æ®µçš„æœ€ç»ˆç»“æœ**
---
## C5. Multi-layer Message Passingï¼ˆå¤šå±‚ GNNï¼‰è®©ä¿¡æ¯çœ‹å¾—æ›´è¿œ

å¤šå±‚ GNN çš„æ ¸å¿ƒé€»è¾‘æ˜¯â€œå¤šæ¬¡è¿­ä»£æ¶ˆæ¯ä¼ é€’â€â€”â€”æ¯ä¸€å±‚å¯¹åº”ä¸€æ¬¡èŠ‚ç‚¹é—´çš„ä¿¡æ¯äº¤æµï¼Œéšç€å±‚æ•°å¢åŠ ï¼ŒèŠ‚ç‚¹èƒ½â€œçœ‹åˆ°â€çš„é‚»å±…èŒƒå›´ä¼šä¸æ–­æ‰©å¤§ï¼Œæœ€ç»ˆæ•æ‰åˆ°æ•´å¼ å›¾çš„å…¨å±€å…³è”ä¿¡æ¯ã€‚

**å±‚çº§ä¸ä¿¡æ¯ä¼ æ’­èŒƒå›´çš„å…³ç³»ï¼š**
- æ¯ä¸€å±‚ = ä¸€æ¬¡å®Œæ•´çš„ Message Passingï¼ˆä¿¡æ¯äº¤æµï¼‰ï¼›
- å¤šå±‚ = è®©èŠ‚ç‚¹çªç ´ç›´æ¥é‚»å±…çš„é™åˆ¶ï¼Œçœ‹åˆ°æ›´è¿œè·ç¦»çš„å…³è”èŠ‚ç‚¹ï¼›
- å…·ä½“ä¼ æ’­èŒƒå›´ï¼š
  - ç¬¬ 1 å±‚ï¼šä»…èƒ½è·å–**ç›´æ¥é‚»å±…**çš„ä¿¡æ¯ï¼ˆå±€éƒ¨å…³è”ï¼‰ï¼›
  - ç¬¬ 2 å±‚ï¼šèƒ½è·å–**é‚»å±…çš„é‚»å±…**çš„ä¿¡æ¯ï¼ˆæ¬¡å…¨å±€å…³è”ï¼‰ï¼›
  - ç¬¬ 3 å±‚åŠä»¥ä¸Šï¼šå¯é€æ­¥è¦†ç›–æ•´å¼ å›¾çš„ä¿¡æ¯ï¼ˆå…¨å±€å…³è”ï¼‰ã€‚

**å¤šå±‚ GNN çš„é€’è¿›æ•ˆæœ**
å¤šå †å‡ å±‚ GNNï¼š
- ç¬¬ä¸€å±‚ï¼šå­¦â€œå±€éƒ¨â€çš„å…³ç³»ï¼ˆä»…ç›´æ¥é‚»å±…ï¼‰
- ç¬¬äºŒå±‚ï¼šå­¦â€œæ›´å…¨å±€â€çš„å…³ç³»ï¼ˆé‚»å±…çš„é‚»å±…ï¼‰

æœ€åæˆ‘ä»¬å¾—åˆ°æ¯ä¸ªç‰©å“ä¸€ä¸ª embeddingï¼Œæ¯”å¦‚ï¼š
>h1 = [0.8, 1.2, -0.5, ...] # æ•´åˆäº†é‚»å±…ä¿¡æ¯çš„ç‰©å“ 1 è¡¨ç¤º
h2 = [1.1, 0.3, 0.7, ...] # æ•´åˆäº†é‚»å±…ä¿¡æ¯çš„ç‰©å“ 2 è¡¨ç¤º
h3 = [-0.2, 2.0, 0.1, ...] # æ•´åˆäº†é‚»å±…ä¿¡æ¯çš„ç‰©å“ 3 è¡¨ç¤º


è¿™äº›å°±æ˜¯ â€œè€ƒè™‘äº†å…¶ä»–ç‰©å“åçš„è¡¨ç¤ºâ€ã€‚


**ä»â€œç‰¹å¾å‘é‡â€åˆ°â€œé€‰æ‹©æ¦‚ç‡â€ï¼šMLP çš„å†³ç­–ä½œç”¨**
ç»è¿‡å¤šå±‚æ¶ˆæ¯ä¼ é€’åï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆç‰©å“ï¼‰ä¼šå¾—åˆ°ä¸€ä¸ªæ•´åˆäº†å…¨å±€ä¿¡æ¯çš„ embedding \( h_i \)ã€‚ä¸ºäº†å°†è¿™ä¸ªé«˜ç»´ç‰¹å¾å‘é‡è½¬åŒ–ä¸ºâ€œæ˜¯å¦é€‰æ‹©è¯¥ç‰©å“â€çš„æ˜ç¡®å†³ç­–ï¼Œæˆ‘ä»¬ä¼šç»™æ¯ä¸ª \( h_i \) æ­é…ä¸€ä¸ªå°å‹å‰é¦ˆç½‘ç»œï¼ˆMLPï¼‰ï¼Œé€šè¿‡çº¿æ€§å˜æ¢+æ¿€æ´»å‡½æ•°è¾“å‡º 0~1 ä¹‹é—´çš„æ¦‚ç‡ï¼š

\[ p_i = \sigma( W \cdot h_i + b ) \]
- \( W \) å’Œ \( b \)ï¼šMLP çš„å¯å­¦ä¹ å‚æ•°ï¼ˆæƒé‡å’Œåç½®ï¼‰ï¼›
- \( \sigma \)ï¼šæ¿€æ´»å‡½æ•°ï¼ˆå¦‚ Sigmoidï¼‰ï¼Œä½œç”¨æ˜¯å°†è¾“å‡ºå‹ç¼©åˆ° 0~1 åŒºé—´ï¼Œå¾—åˆ°æ¦‚ç‡å€¼ï¼›
- \( p_i \)ï¼šç‰©å“ \( i \) è¢«é€‰ä¸­çš„æ¦‚ç‡ã€‚

**ç›´è§‰ç†è§£ï¼šæ¦‚ç‡çš„å®é™…å«ä¹‰**
- \( p_i \) è¶Šæ¥è¿‘ 1 â†’ æ¨¡å‹åˆ¤æ–­â€œè¯¥ç‰©å“è¢«é€‰ä¸­èƒ½æå‡æ€»ä»·å€¼ï¼Œåº”è¯¥é€‰â€ï¼›
- \( p_i \) è¶Šæ¥è¿‘ 0 â†’ æ¨¡å‹åˆ¤æ–­â€œè¯¥ç‰©å“é€‰ä¸­åå¯èƒ½è¶…é‡æˆ–ä»·å€¼è¾ƒä½ï¼Œä¸åº”è¯¥é€‰â€ã€‚

**æœ€ç»ˆå†³ç­–ï¼šæ¦‚ç‡é˜ˆå€¼åŒ–**
å¾—åˆ°æ‰€æœ‰ç‰©å“çš„é€‰æ‹©æ¦‚ç‡åï¼Œæˆ‘ä»¬é€šè¿‡â€œé˜ˆå€¼åŒ–â€å°†æ¦‚ç‡è½¬åŒ–ä¸ºæ˜ç¡®çš„ 0/1 å†³ç­–ï¼ˆå¯¹åº”èƒŒåŒ…é—®é¢˜çš„â€œæ‹¿â€æˆ–â€œä¸æ‹¿â€ï¼‰ï¼š
\[ 
x_i = 
\begin{cases} 
1 & \text{if } p_i > 0.5 \\
0 & \text{if } p_i \leq 0.5 
\end{cases}
\]

**ç¤ºä¾‹ï¼šä»æ¦‚ç‡åˆ°æœ€ç»ˆç­”æ¡ˆ**
å‡è®¾ç»è¿‡å¤šå±‚ GNN è®¡ç®—åï¼Œå¾—åˆ° 3 ä¸ªç‰©å“çš„é€‰æ‹©æ¦‚ç‡ï¼š\( p_1=0.92 \)ã€\( p_2=0.87 \)ã€\( p_3=0.31 \)ï¼Œé˜ˆå€¼è®¾ä¸º 0.5ï¼Œåˆ™æœ€ç»ˆå†³ç­–ä¸ºï¼š
\[ \text{é¢„æµ‹çš„ } x = [1, 1, 0] \]

**æ¨¡å‹æ•ˆæœéªŒè¯**
å°†è¿™ä¸ªé¢„æµ‹ç»“æœä¸åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰ç­‰æ–¹æ³•ç®—å‡ºçš„æœ€ä¼˜ç­”æ¡ˆï¼ˆå¦‚åŒæ ·æ˜¯ [1,1,0]ï¼‰è¿›è¡Œæ¯”å¯¹ï¼š
- è‹¥é¢„æµ‹ç»“æœä¸æœ€ä¼˜ç­”æ¡ˆé«˜åº¦ä¸€è‡´ â†’ è¯´æ˜æ¨¡å‹å·²å­¦ä¼šèƒŒåŒ…é—®é¢˜çš„ç»„åˆä¼˜åŒ–è§„å¾‹ï¼Œå­¦å¾—ä¸é”™ï¼›
- è‹¥å­˜åœ¨åå·® â†’ å¯é€šè¿‡è°ƒæ•´ GNN å±‚æ•°ã€MLP ç»“æ„æˆ–è®­ç»ƒç­–ç•¥è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚
---
# D. Readoutï¼ˆå›¾çº§åˆ«èšåˆ Â· å¯é€‰ï¼‰
å¦‚æœä»»åŠ¡æ˜¯å›¾åˆ†ç±»ï¼ˆgraph-levelï¼‰ï¼Œéœ€è¦ï¼š
- sum pooling
- mean pooling
- max pooling
- attention pooling

Knapsack å¤šä¸º node-levelï¼Œä½† Readout æ˜¯ GNN åŸºç¡€ç»„ä»¶ã€‚

---
# E. Decision Makingï¼ˆå†³ç­–é˜¶æ®µï¼‰

## E1. MLP classifier
```
p_i = Ïƒ(W Â· h_i + b)
```
è¾“å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„â€œé€‰æ‹©æ¦‚ç‡â€ã€‚

## E2. Thresholding
```
x_i = 1 if p_i > 0.5 else 0
```

---
# F. Training Pipelineï¼ˆè®­ç»ƒæµç¨‹ï¼‰

## F1. Loss Functionï¼ˆæŸå¤±å‡½æ•°ï¼‰
### 1) åˆ†ç±»æŸå¤±
```
loss_cls = BCE(p_i, y_i)
```
### 2) å®¹é‡çº¦æŸæƒ©ç½šï¼ˆKnapsack å…³é”®ï¼‰
```
penalty = Î» Â· max(0, Î£(w_i Â· x_i) - W)
```
### æ€»æŸå¤±
```
loss = loss_cls + penalty
```

---
## F2. Optimizer
- Adamï¼ˆæœ€å¸¸ç”¨ï¼‰
- éœ€è¦è®¾ç½®å­¦ä¹ ç‡ lr

---
## F3. Batch æ„å»ºæ–¹å¼
- æ¯ä¸ª knapsack å®ä¾‹æ˜¯ä¸€å¼ å›¾
- ä½¿ç”¨ DataLoader ç»„æˆ batch

---
## F4. Epoch è®­ç»ƒ
å…¸å‹æµç¨‹ï¼š
1. forwardï¼ˆmessage passing â†’ outputï¼‰
2. compute loss
3. backwardï¼ˆæ¢¯åº¦ï¼‰
4. stepï¼ˆæ›´æ–°å‚æ•°ï¼‰
5. repeat å¤š epoch

---
# ğŸ“Œ GNN å…¨æµç¨‹æ€»ç»“
```
å›¾æ„å»ºï¼ˆnode + edge + ç»“æ„å®šä¹‰ï¼‰
        â†“
åˆå§‹ embedding
        â†“
å¤šå±‚ message passing
        â†“
å†³ç­–ï¼ˆMLP + thresholdï¼‰
        â†“
Lossï¼ˆåˆ†ç±» + è¶…é‡æƒ©ç½šï¼‰
        â†“
è®­ç»ƒï¼ˆAdam + epochï¼‰
```

